<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatOps • Tactical Intelligence Engine</title>
    <!-- Dependencias: React, Tailwind, Framer Motion y Lucide -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .red-glow { box-shadow: 0 0 20px rgba(220, 38, 38, 0.2); }
        textarea::placeholder { color: #334155; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .blur-text { filter: blur(4px); pointer-events: none; user-select: none; }
        input:focus, textarea:focus { border-color: #dc2626 !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Integración de Framer Motion vía CDN
        const { motion, AnimatePresence } = window.Motion || { 
            motion: { div: 'div', section: 'section', header: 'header', main: 'main', button: 'button', p: 'p', h2: 'h2', span: 'span', i: 'i' }, 
            AnimatePresence: ({children}) => children 
        };

        // --- CONFIGURACIÓN ESTRATÉGICA ---
        const apiKey = "AIzaSyCCp-ftyltZkgsajxDt1-gQ2IF5VCyA2p8"; 
        const MODEL_ID = "gemini-2.5-flash-preview-09-2025";
        const COOLDOWN_TIME = 60 * 60 * 1000; // 1 Hora de espera
        const CONTACT_NUMBER = "672680535";
        const BRAND_NAME = "Preemptive Movement";

        // Componente de Iconos Lucide
        const Icon = ({ name, size = 20, className = "" }) => {
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-flex' }}></i>;
        };

        const App = () => {
            const [chatInput, setChatInput] = useState('');
            const [context, setContext] = useState('cita');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [result, setResult] = useState(null);
            const [freeUses, setFreeUses] = useState(3);
            const [lastUseTimestamp, setLastUseTimestamp] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);
            const [showContact, setShowContact] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                const savedCredits = localStorage.getItem('chatops_credits_v7');
                const savedTime = localStorage.getItem('chatops_cooldown_v7');
                
                if (savedCredits !== null) setFreeUses(parseInt(savedCredits));
                if (savedTime !== null) setLastUseTimestamp(parseInt(savedTime));
                
                if (window.lucide) window.lucide.createIcons();
            }, []);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [result, isAnalyzing, showContact, timeLeft]);

            useEffect(() => {
                if (freeUses <= 0 && lastUseTimestamp) {
                    const interval = setInterval(() => {
                        const now = Date.now();
                        const diff = (lastUseTimestamp + COOLDOWN_TIME) - now;
                        if (diff <= 0) {
                            setFreeUses(1); 
                            setTimeLeft(0);
                            localStorage.setItem('chatops_credits_v7', "1");
                            clearInterval(interval);
                        } else {
                            setTimeLeft(diff);
                        }
                    }, 1000);
                    return () => clearInterval(interval);
                }
            }, [freeUses, lastUseTimestamp]);

            const fetchWithRetry = async (url, options, retries = 3, backoff = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (retries <= 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
            };

            const callAI = async (text, ctx) => {
                const systemPrompt = `Eres un Motor de Decisión Social Senior de la marca ${BRAND_NAME}. Analiza chats y da un diagnóstico táctico frío, asertivo y directo. Prohibido usar "quizás", "depende" o lenguaje terapéutico. Contexto: ${ctx}. Salida JSON estricta: { "intention": "frase corta", "interest": 0-100, "risk": "Bajo/Medio/Alto", "action": "acción concreta", "recommendedMsg": "mensaje listo para enviar" }`;
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: `Analiza este hilo de mensajes: "${text}"` }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
                };

                const data = await fetchWithRetry(url, { 
                    method: 'POST', 
                    body: JSON.stringify(payload), 
                    headers: {'Content-Type': 'application/json'} 
                });

                const rawResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawResponse) throw new Error("IA no devolvió datos");
                return JSON.parse(rawResponse);
            };

            const handleAnalyze = async () => {
                if (chatInput.trim().length < 10) return;
                
                if (freeUses <= 0) {
                    setShowContact(true);
                    return;
                }
                
                setIsAnalyzing(true);
                setError(null);
                try {
                    const diagnosis = await callAI(chatInput, context);
                    setResult(diagnosis);
                    
                    const newUses = freeUses - 1;
                    setFreeUses(newUses);
                    
                    if (newUses === 0) {
                        const now = Date.now();
                        setLastUseTimestamp(now);
                        localStorage.setItem('chatops_cooldown_v7', now.toString());
                    }
                    
                    localStorage.setItem('chatops_credits_v7', newUses.toString());
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (e) {
                    setError(`FALLO EN EL ENLACE: ${e.message}`);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const formatTime = (ms) => {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            };

            const handleContact = () => {
                // He añadido un fragmento del chat para que el consultor tenga contexto inmediato
                const chatSnippet = chatInput ? `\n\nCaso a analizar:\n"${chatInput.substring(0, 150)}..."` : "";
                const msg = `Hola Antonio, solicito un análisis táctico profundo. El sistema automático ChatOps ha agotado su capacidad.${chatSnippet}`;
                window.open(`https://wa.me/34${CONTACT_NUMBER}?text=${encodeURIComponent(msg)}`);
            };

            return (
                <div className="min-h-screen p-6 max-w-md mx-auto pb-32">
                    <header className="flex justify-between items-center mb-10 pb-6 border-b border-slate-800">
                        <div className="flex items-center gap-3">
                            <div className="bg-red-600 p-2 rounded-xl shadow-lg shadow-red-900/30">
                                <Icon name="zap" className="text-white fill-current" />
                            </div>
                            <div>
                                <h1 className="font-black text-2xl tracking-tighter italic uppercase leading-none text-white">ChatOps</h1>
                                <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest">{BRAND_NAME}</span>
                            </div>
                        </div>
                        <div className="bg-slate-900 px-3 py-1 rounded-full border border-slate-800 flex items-center gap-2">
                             <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse" />
                             <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">System Active</span>
                        </div>
                    </header>

                    <main>
                        <AnimatePresence mode="wait">
                            {!result ? (
                                <motion.div key="input" initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} exit={{opacity:0, y:-10}} className="space-y-8">
                                    <div className="space-y-2">
                                        <h2 className="text-4xl font-black tracking-tighter uppercase italic leading-none tracking-tight text-white">Descifra la intención.</h2>
                                        <p className="text-slate-500 font-bold text-xs uppercase tracking-[0.2em]">Diagnóstico social de alta criticidad.</p>
                                    </div>

                                    <div className="relative group">
                                        <textarea 
                                            value={chatInput}
                                            onChange={(e) => setChatInput(e.target.value)}
                                            placeholder="Pega el hilo de mensajes aquí..."
                                            className="w-full h-80 bg-slate-900 border-2 border-slate-800 rounded-[2.5rem] p-7 text-slate-200 focus:border-red-600 outline-none transition-all resize-none shadow-2xl font-mono text-sm shadow-black/50"
                                        />
                                    </div>

                                    <div className="space-y-4">
                                        <label className="text-[10px] font-black uppercase text-slate-500 flex items-center gap-2 ml-2 tracking-widest">
                                            <Icon name="target" size={12} /> Contexto Operativo
                                        </label>
                                        <div className="flex flex-wrap gap-2">
                                            {['pareja', 'cita', 'trabajo', 'negociación'].map(c => (
                                                <button 
                                                    key={c} 
                                                    onClick={() => setContext(c)}
                                                    className={`px-5 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest border transition-all ${context === c ? 'bg-white text-black border-white scale-105 shadow-xl shadow-white/5' : 'border-slate-800 text-slate-500 hover:border-slate-600'}`}
                                                >
                                                    {c}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-4 pt-2">
                                        <button 
                                            onClick={handleAnalyze}
                                            disabled={isAnalyzing || chatInput.length < 10 || (freeUses <= 0 && timeLeft > 0)}
                                            className={`w-full py-6 rounded-[2.5rem] font-black text-xl uppercase tracking-[0.2em] flex items-center justify-center gap-4 transition-all shadow-2xl relative overflow-hidden ${isAnalyzing || (freeUses <= 0 && timeLeft > 0) ? 'bg-slate-800 text-slate-600 cursor-not-allowed border border-slate-700' : 'bg-red-600 text-white active:scale-95 shadow-red-900/40 border-b-4 border-red-800 active:border-b-0'}`}
                                        >
                                            {isAnalyzing ? (
                                                <><Icon name="refresh-ccw" className="animate-spin" size={24} /> PROCESANDO...</>
                                            ) : (
                                                <><Icon name="zap" size={24} /> ANALIZAR</>
                                            )}
                                        </button>

                                        <div className="bg-slate-900/40 p-5 rounded-[2rem] border border-slate-900 text-center shadow-inner">
                                            {freeUses > 0 ? (
                                                <p className="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">
                                                    Análisis disponibles: <span className="text-red-500">{freeUses}</span>
                                                </p>
                                            ) : timeLeft > 0 ? (
                                                <div className="flex flex-col items-center gap-1.5">
                                                    <p className="text-[10px] font-black text-yellow-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                                        <Icon name="timer" size={12} /> Recalibrando: {formatTime(timeLeft)}
                                                    </p>
                                                    <button onClick={() => setShowContact(true)} className="text-[9px] text-slate-500 underline uppercase font-black hover:text-slate-300">
                                                        Bypass vía Operador
                                                    </button>
                                                </div>
                                            ) : null}
                                        </div>
                                    </div>
                                    {error && (
                                        <div className="bg-red-950/20 border border-red-900/30 p-4 rounded-2xl">
                                            <p className="text-red-600 text-[10px] font-bold uppercase text-center">{error}</p>
                                        </div>
                                    )}
                                </motion.div>
                            ) : (
                                <motion.div key="result" initial={{x:30, opacity:0}} animate={{x:0, opacity:1}} className="space-y-6">
                                    <button onClick={() => setResult(null)} className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-2 hover:text-white transition-colors tracking-widest mb-4 text-white">
                                        <Icon name="refresh-ccw" size={14} /> Nueva Evaluación
                                    </button>

                                    <div className="bg-slate-900 border border-slate-800 p-7 rounded-[2rem] shadow-2xl border-l-4 border-l-red-600">
                                        <span className="text-[10px] font-black text-red-600 uppercase tracking-widest block mb-3">Intención Real Detectada</span>
                                        <p className="text-2xl font-black uppercase italic leading-none tracking-tighter text-white">{result.intention}</p>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 text-center text-white">
                                            <span className="text-[9px] font-bold text-slate-500 uppercase block mb-1">Interés</span>
                                            <p className="text-4xl font-black text-green-400 leading-none">{result.interest}%</p>
                                        </div>
                                        <div className="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 text-center text-white">
                                            <span className="text-[9px] font-bold text-slate-500 uppercase block mb-1">Riesgo</span>
                                            <p className={`text-2xl font-black uppercase leading-none ${result.risk === 'Bajo' ? 'text-green-400' : result.risk === 'Medio' ? 'text-yellow-400' : 'text-red-600'}`}>{result.risk}</p>
                                        </div>
                                    </div>

                                    <div className="bg-slate-900 p-7 rounded-[2rem] border border-slate-800 shadow-lg">
                                        <span className="text-[10px] font-black text-yellow-500 uppercase tracking-widest block mb-3">Qué hacer ahora</span>
                                        <p className="font-bold italic text-slate-100 leading-relaxed text-lg">"{result.action}"</p>
                                    </div>

                                    <div className="bg-red-600/5 border border-red-600/20 p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                                        <span className="text-[10px] font-black text-red-500 uppercase block mb-5 tracking-widest">Respuesta Recomendada</span>
                                        <div className="bg-slate-950/90 p-6 rounded-2xl border border-slate-800 font-mono text-sm mb-6 shadow-inner leading-relaxed select-all text-slate-100">
                                            {result.recommendedMsg}
                                        </div>
                                        <button 
                                            onClick={() => {
                                                const el = document.createElement('textarea');
                                                el.value = result.recommendedMsg;
                                                document.body.appendChild(el); el.select();
                                                document.execCommand('copy'); document.body.removeChild(el);
                                            }}
                                            className="w-full py-5 bg-red-600 rounded-2xl font-black uppercase tracking-widest text-sm shadow-xl shadow-red-900/30 flex items-center justify-center gap-3 active:scale-95 transition-all text-white"
                                        >
                                            <Icon name="copy" size={20} /> Copiar Respuesta
                                        </button>
                                    </div>

                                    <div className="relative h-64 overflow-hidden rounded-[2.5rem] border border-slate-800 flex items-center justify-center text-center p-8 bg-slate-900/20">
                                        <div className="absolute inset-0 bg-slate-950/90 backdrop-blur-xl z-10 flex flex-col items-center justify-center p-6">
                                            <Icon name="lock" className="text-red-600 mb-4 animate-bounce" size={40} />
                                            <h3 className="font-black uppercase tracking-tighter text-xl italic mb-2 text-white">Protocolo de 2º Orden</h3>
                                            <p className="text-[10px] text-slate-500 uppercase font-bold max-w-[200px] mb-8 leading-tight tracking-widest">Análisis automático saturado. Requiere intervención manual.</p>
                                            <button onClick={handleContact} className="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-widest flex items-center justify-center gap-3 shadow-xl shadow-white/5">
                                                <Icon name="phone" size={14} /> Contactar Operador H50
                                            </button>
                                        </div>
                                        <div className="space-y-4 w-full opacity-20 filter blur-sm">
                                             <div className="h-4 bg-slate-700 w-full rounded"></div>
                                             <div className="h-4 bg-slate-700 w-3/4 rounded"></div>
                                             <div className="h-4 bg-slate-700 w-1/2 rounded"></div>
                                        </div>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </main>

                    {/* MODAL DE CONTACTO / LÍMITE */}
                    <AnimatePresence>
                        {showContact && (
                            <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} className="fixed inset-0 z-50 bg-slate-950/98 backdrop-blur-md flex items-center justify-center p-8">
                                <motion.div initial={{y:50}} animate={{y:0}} className="bg-slate-900 border border-slate-800 rounded-[3rem] p-10 space-y-8 w-full max-w-sm text-center shadow-2xl relative overflow-hidden">
                                    <div className="bg-red-600/10 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4 border border-red-600/20 text-red-600">
                                        <Icon name="shield-alert" size={40} />
                                    </div>
                                    <h3 className="text-2xl font-black uppercase italic tracking-tighter leading-none text-white">Límite Alcanzado</h3>
                                    {timeLeft > 0 ? (
                                        <p className="text-slate-400 text-xs font-bold uppercase leading-relaxed tracking-widest">
                                            Sistema en enfriamiento. <br/>Vuelve en <span className="text-white font-black">{formatTime(timeLeft)}</span> o contacta al operador para bypass inmediato.
                                        </p>
                                    ) : (
                                        <p className="text-slate-400 text-xs font-bold uppercase leading-relaxed tracking-widest leading-loose">
                                            Para situaciones de alta criticidad o urgencia social, contacta directamente con el operador de campo.
                                        </p>
                                    )}
                                    <div className="space-y-3 pt-4">
                                        <button onClick={handleContact} className="w-full py-5 bg-red-600 rounded-[1.5rem] font-black uppercase tracking-[0.2em] text-sm shadow-xl active:scale-95 shadow-red-900/40 text-white">Abrir WhatsApp</button>
                                        <button onClick={() => setShowContact(false)} className="text-[10px] text-slate-600 uppercase font-black tracking-widest block mx-auto py-2 text-white">Cerrar</button>
                                    </div>
                                    <div className="pt-4 opacity-30">
                                        <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest tracking-[0.5em]">{BRAND_NAME} STRATEGY</span>
                                    </div>
                                </motion.div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    <footer className="fixed bottom-0 left-0 w-full p-6 text-center text-[9px] font-black text-slate-700 uppercase tracking-[0.5em] z-40 bg-slate-950/90 border-t border-slate-900 backdrop-blur-md">
                        Data Link Secure • No Logs Stored
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
